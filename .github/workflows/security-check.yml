name: ðŸ›¡ï¸ Security Vulnerability Check

on:
  schedule:
    - cron: '0 2 * * 1'  # æ¯å‘¨ä¸€å‡Œæ™¨2ç‚¹è¿è¡Œ
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  PYTHON_VERSION: '3.11'

jobs:
  security-scan:
    name: ðŸ” Security Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v6
      
    - name: ðŸ Setup Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v6
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        
    - name: ðŸ”§ Install Dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install safety pip-audit
        if [ -f requirements.txt ]; then
          pip install -r requirements.txt
        fi
        
    - name: ðŸ›¡ï¸ Run Safety Scan
      continue-on-error: true
      run: |
        safety scan --json --output safety_results.json || echo "Safety scan completed with issues"
        
    - name: ðŸ” Run pip-audit Scan  
      continue-on-error: true
      run: |
        pip-audit --format=json --output=pip_audit_results.json || echo "pip-audit scan completed"
        
    - name: ðŸ“‹ Generate Security Report
      run: |
        python fix_vulnerabilities.py --report-only
        
    - name: ðŸ“¤ Upload Security Reports
      uses: actions/upload-artifact@v6
      with:
        name: security-reports-${{ github.sha }}
        path: |
          security_report.md
          safety_results.json
          pip_audit_results.json
        retention-days: 30
        
    - name: ðŸ“Š Display Security Summary
      run: |
        echo "## ðŸ›¡ï¸ Security Scan Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "security_report.md" ]; then
          echo "### ðŸ“‹ Security Report Generated" >> $GITHUB_STEP_SUMMARY
          echo "- Report available in artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- Check the uploaded artifacts for detailed analysis" >> $GITHUB_STEP_SUMMARY
        else
          echo "### âŒ Security Report Generation Failed" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ” Scan Tools Used" >> $GITHUB_STEP_SUMMARY
        echo "- Safety: Python security vulnerability scanner" >> $GITHUB_STEP_SUMMARY  
        echo "- pip-audit: PyPI package auditing tool" >> $GITHUB_STEP_SUMMARY
        
  auto-fix:
    name: ðŸ”§ Auto Fix Vulnerabilities
    runs-on: ubuntu-latest
    needs: security-scan
    if: github.event_name == 'workflow_dispatch' && github.ref == 'refs/heads/main'
    permissions:
      contents: write
      pull-requests: write
      
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v6
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ðŸ Setup Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v6
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        
    - name: ðŸ”§ Install Dependencies and Security Tools
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install safety pip-audit
        if [ -f requirements.txt ]; then
          pip install -r requirements.txt
        fi
        
    - name: ðŸ›¡ï¸ Auto Fix Vulnerabilities
      run: |
        python fix_vulnerabilities.py --auto-fix
        
    - name: ðŸ“ Check for Changes
      id: changes
      run: |
        if git diff --quiet; then
          echo "changes=false" >> $GITHUB_OUTPUT
          echo "No changes detected"
        else
          echo "changes=true" >> $GITHUB_OUTPUT
          echo "Changes detected"
          git diff --name-only
        fi
        
    - name: ðŸš€ Create Pull Request
      if: steps.changes.outputs.changes == 'true'
      uses: peter-evans/create-pull-request@v8
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: |
          ðŸ›¡ï¸ Fix security vulnerabilities
          
          - Updated vulnerable packages to secure versions
          - Updated requirements.txt with latest secure versions
          - Generated security report for review
        title: "ðŸ›¡ï¸ Auto-fix security vulnerabilities"
        body: |
          ## ðŸ›¡ï¸ Security Vulnerability Auto-Fix
          
          This PR was automatically generated to fix detected security vulnerabilities.
          
          ### ðŸ” Changes Made
          - âœ… Updated vulnerable packages to secure versions
          - âœ… Updated `requirements.txt` with latest versions  
          - âœ… Generated security report for review
          
          ### ðŸ§ª Testing Required
          Please test the application thoroughly before merging:
          - [ ] Unit tests pass
          - [ ] Integration tests pass  
          - [ ] Manual testing completed
          - [ ] Security report reviewed
          
          ### ðŸ“‹ Security Report
          The detailed security report is available in the artifacts of the workflow run.
          
          ### ðŸ”„ Rollback Instructions
          If issues arise after merging, you can rollback using the backup files:
          ```bash
          cp requirements.txt.backup requirements.txt
          pip install -r requirements.txt
          ```
          
          ---
          ðŸ¤– This PR was created automatically by the Security Vulnerability Check workflow.
        branch: security/auto-fix-vulnerabilities
        delete-branch: true
        labels: |
          security
          dependencies
          automated
        reviewers: |
          ${{ github.repository_owner }}
          
    - name: ðŸ“Š Update Summary
      if: steps.changes.outputs.changes == 'true'
      run: |
        echo "## ðŸ›¡ï¸ Security Auto-Fix Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âœ… Actions Taken" >> $GITHUB_STEP_SUMMARY
        echo "- Automatically fixed security vulnerabilities" >> $GITHUB_STEP_SUMMARY
        echo "- Created pull request with fixes" >> $GITHUB_STEP_SUMMARY
        echo "- Generated security report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”— Next Steps" >> $GITHUB_STEP_SUMMARY
        echo "- Review the created pull request" >> $GITHUB_STEP_SUMMARY
        echo "- Run tests to verify compatibility" >> $GITHUB_STEP_SUMMARY
        echo "- Merge after validation" >> $GITHUB_STEP_SUMMARY
        
    - name: ðŸ“Š No Changes Summary
      if: steps.changes.outputs.changes == 'false'
      run: |
        echo "## âœ… No Security Issues Found" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY  
        echo "All dependencies are up to date and secure!" >> $GITHUB_STEP_SUMMARY